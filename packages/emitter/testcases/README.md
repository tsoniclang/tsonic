# Golden Test Suite

This directory contains **golden tests** for the Tsonic emitter - tests that verify the exact C# output generated from TypeScript input.

## Two Runtime Modes

Tsonic supports two runtime modes with different API availability:

| Mode | Type Roots | APIs Available |
|------|------------|----------------|
| **dotnet** | `@tsonic/globals` | Native .NET: `name.Length`, `list.Count` |
| **js** | `@tsonic/globals` + `@tsonic/js-globals` | JSRuntime: `String.length(name)`, `.map()`, `.filter()` |

Tests are organized to work with both modes where possible.

## Directory Structure

```
testcases/
├── common/                    # Tests that work in BOTH modes (27 tests)
│   ├── arrays/basic/
│   │   ├── ArrayLiteral.ts    # Source file (shared)
│   │   └── config.yaml        # Test configuration
│   ├── dotnet/                # Expected .cs for dotnet mode
│   │   └── arrays/basic/
│   │       └── ArrayLiteral.cs
│   └── js/                    # Expected .cs for js mode
│       └── arrays/basic/
│           └── ArrayLiteral.cs
└── js-only/                   # Tests that ONLY work in JS mode (25 tests)
    └── arrays/methods/
        ├── ArrayMethods.ts    # Source
        ├── config.yaml        # Config
        └── ArrayMethods.cs    # Expected (js mode only)
```

### Why Two Expected Outputs for Common Tests?

The same TypeScript generates different C# depending on the mode:

**TypeScript:**
```typescript
export function isValid(name: string): boolean {
  return name.length > 0;
}
```

**Dotnet mode output:**
```csharp
return name.Length > 0;  // Native .NET
```

**JS mode output:**
```csharp
return global::Tsonic.JSRuntime.String.length(name) > 0;  // JSRuntime wrapper
```

## Config File Format

Each test directory contains a `config.yaml`:

```yaml
tests:
  - input: ArrayLiteral.ts
    title: should emit array literals correctly

  # For diagnostic tests (no .cs file needed):
  - input: InvalidCode.ts
    title: should emit TSN1234 for invalid input
    expectDiagnostics:
      - TSN1234
```

## Test Categories

### Common Tests (work in both modes)
- **arrays/**: basic, destructuring, multidimensional, spread
- **async/**: basic (Promise is in both modes)
- **classes/**: basic, constructor, field-inference, inheritance, static-members
- **control-flow/**: switch
- **edge-cases/**: generic-null-default, nested-scopes, shadowing
- **functions/**: arrow, basic, closures, default-params
- **operators/**: nullish-coalescing, optional-chaining
- **structs/**: basic
- **types/**: anonymous-objects, conditional, constants, dictionaries, generics, interfaces, mapped, tuples-arity, utility-types

### JS-Only Tests (require JS APIs)
- **arrays/methods** - `.map()`, `.filter()`, `.reduce()`
- **classes/abstract** - `Math.PI`, `Math.abs()`
- **control-flow/error-handling** - `console`, `Error`
- **control-flow/loops** - `.length`
- **operators/logical** - `name.length`
- **real-world/** - All use console, Math, array/string methods
- **types/unions** - `.toUpperCase()`

## Running Tests

```bash
# Run all emitter tests (including golden tests)
npm run test:emitter

# Run only golden tests
npm run test:emitter -- --grep "Golden Tests"

# Run specific mode
npm run test:emitter -- --grep "Golden Tests (dotnet mode)"
npm run test:emitter -- --grep "Golden Tests (js mode)"
```

## Updating Expected Files

When the emitter changes, regenerate expected files:

```bash
cd packages/emitter

# Update both modes
npx tsx scripts/update-golden-tests.ts

# Update specific mode
npx tsx scripts/update-golden-tests.ts dotnet
npx tsx scripts/update-golden-tests.ts js
```

## Adding a New Test

### For both modes (common/):

1. Create test directory:
   ```bash
   mkdir -p testcases/common/category/subcategory
   ```

2. Add source and config:
   ```
   common/category/subcategory/
   ├── MyTest.ts
   └── config.yaml
   ```

3. Generate expected files:
   ```bash
   npx tsx scripts/update-golden-tests.ts
   ```

   This creates:
   - `common/dotnet/category/subcategory/MyTest.cs`
   - `common/js/category/subcategory/MyTest.cs`

### For JS mode only (js-only/):

1. Create test directory:
   ```bash
   mkdir -p testcases/js-only/category/subcategory
   ```

2. Add source, config, and expected together:
   ```
   js-only/category/subcategory/
   ├── MyTest.ts
   ├── config.yaml
   └── MyTest.cs  # Generated by update script
   ```

3. Generate expected file:
   ```bash
   npx tsx scripts/update-golden-tests.ts js
   ```

## Namespace Calculation

Namespace is derived from the path including `common` or `js-only`:

```
common/arrays/basic/ArrayLiteral.ts
    └─ TestCases.common.arrays.basic.ArrayLiteral

js-only/real-world/calculator/calculator.ts
    └─ TestCases.jsonly.realworld.calculator.calculator
```

## See Also

- [Emitter Implementation](../src/emitter.ts)
- [Golden Test Harness](../src/golden.test.ts)
- [Discovery Logic](../src/golden-tests/discovery.ts)
- [Update Script](../scripts/update-golden-tests.ts)
